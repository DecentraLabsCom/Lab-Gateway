services:
  blockchain-services:
    image: hashicorp/http-echo:0.2.3
    command: ["-listen=:8080", "-text=ok"]

  guacamole:
    build:
      context: ./mocks/guacamole
      dockerfile: Dockerfile

  openresty:
    build:
      context: ../../openresty
      dockerfile: Dockerfile
    environment:
      GUAC_ADMIN_USER: admin
      GUAC_ADMIN_PASS: secret
      SERVER_NAME: lab.test
      HTTPS_PORT: "18443"
      GUAC_API_URL: http://guacamole:8080/guacamole/api
      OPS_SECRET: test-ops-secret-123
    volumes:
      - ./certs:/etc/ssl/private
      - ../../openresty/lab_access.conf:/etc/openresty/lab_access.conf:ro
      - ../../openresty/nginx.conf:/usr/local/openresty/nginx/conf/nginx.conf:ro
      - ../../openresty/lua:/etc/openresty/lua:ro
      - ../../web:/var/www/html:ro
    ports:
      - "18443:443"
    depends_on:
      guacamole:
        condition: service_started
      ops-worker:
        condition: service_healthy

  ops-worker:
    image: hashicorp/http-echo:0.2.3
    command: ["-listen=:8081", "-text=ops-worker-ok"]
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "8081"]
      interval: 2s
      timeout: 1s
      retries: 10
      start_period: 1s
