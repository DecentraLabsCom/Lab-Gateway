name: Release

on:
  push:
    tags:
      - "v*.*.*"

jobs:
  package-release:
    name: Build & Publish Release
    runs-on: ubuntu-latest
    permissions:
      contents: write

    env:
      DIST_DIR: dist

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Run Lua unit tests with coverage
        run: >
          docker run --rm -v "${{ github.workspace }}:/workspace" -w /workspace
          openresty/openresty:alpine-fat sh -c
          "luarocks install luacov >/dev/null &&
           luajit -lluacov openresty/tests/run.lua &&
           luacov"

      - name: Run OpenResty smoke test
        run: |
          chmod +x tests/smoke/run-smoke.sh
          tests/smoke/run-smoke.sh

      - name: Stage distribution directory
        run: |
          rm -rf "$DIST_DIR"
          mkdir -p "$DIST_DIR/lab-gateway-full-${{ steps.version.outputs.VERSION }}"
          rsync -a \
            --exclude='.git' \
            --exclude='dist' \
            --exclude='blockchain-data' \
            --exclude='*.log' \
            --exclude='luacov.report.out' \
            --exclude='luacov.stats.out' \
            ./ "$DIST_DIR/lab-gateway-full-${{ steps.version.outputs.VERSION }}/"

      - name: Build archives
        run: |
          cd "$DIST_DIR"
          tar -czf "lab-gateway-full-${{ steps.version.outputs.VERSION }}.tar.gz" "lab-gateway-full-${{ steps.version.outputs.VERSION }}"
          zip -qr "lab-gateway-full-${{ steps.version.outputs.VERSION }}.zip" "lab-gateway-full-${{ steps.version.outputs.VERSION }}"

      - name: Generate checksums
        run: |
          cd "$DIST_DIR"
          sha256sum "lab-gateway-full-${{ steps.version.outputs.VERSION }}.tar.gz" > "lab-gateway-full-${{ steps.version.outputs.VERSION }}.tar.gz.sha256"
          sha256sum "lab-gateway-full-${{ steps.version.outputs.VERSION }}.zip" > "lab-gateway-full-${{ steps.version.outputs.VERSION }}.zip.sha256"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/lab-gateway-full-${{ steps.version.outputs.VERSION }}.tar.gz
            dist/lab-gateway-full-${{ steps.version.outputs.VERSION }}.tar.gz.sha256
            dist/lab-gateway-full-${{ steps.version.outputs.VERSION }}.zip
            dist/lab-gateway-full-${{ steps.version.outputs.VERSION }}.zip.sha256
          body: |
            ## üöÄ Lab Gateway ${{ steps.version.outputs.VERSION }}

            ### üì¶ What's Included
            - Docker Compose stack (OpenResty, Guacamole, MySQL, blockchain-services submodule)
            - Setup scripts for Windows (`setup.bat`) and Linux/macOS (`setup.sh`)
            - Smoke-test tooling and Lua unit tests
            - Documentation and environment templates

            ### ‚úÖ Before Deploying
            1. Copy `.env.example` to `.env` and review every variable (domain, blockchain RPC, DB credentials, JWT/Wallet settings).
            2. Run `setup.bat` or `setup.sh` to initialize secrets, TLS/JWT keys, and the `blockchain-data/` volume for wallet persistence.
            3. Start the stack with `docker compose up -d`.
            4. Visit `https://<host>/wallet-dashboard` to create/import the institutional wallet and update `.env` / `blockchain-services/.env` with the resulting address & password.
            5. Run `tests/smoke/run-smoke.sh` after configuring your domain to verify headers and session guard logic.

            ### üîê Security Checklist
            - Regenerate RSA/JWT keys in production and store them securely.
            - Rotate MySQL and Guacamole credentials before exposing the stack.
            - Configure HTTPS either via OpenResty or your upstream load balancer.
            - Keep the `blockchain-services` submodule aligned with the commit recorded in this release.

            ### üìö Docs
            - README.md ‚Äì full architecture and operations guide
            - LOGGING.md ‚Äì logging strategy & shipping tips
            - `tests/smoke/run-smoke.sh` ‚Äì smoke test entrypoint with inline instructions
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
