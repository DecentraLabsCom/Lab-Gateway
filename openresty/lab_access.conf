lua_package_path "/usr/local/openresty/site/lualib/resty/?.lua;/usr/local/lib/luarocks/share/lua/5.1/?.lua;/etc/openresty/lua/?.lua;/etc/openresty/lua/?/init.lua;;";

# Basic rate limiting for /intents (30 req/min per IP; burst 10)
limit_req_zone $binary_remote_addr zone=intents:10m rate=30r/m;

# Lua code to initialize config variables and to read the public key of the auth service from a file
init_by_lua_file /etc/openresty/lua/init.lua;

# Lua code to periodically check for expired sessions and terminate active connections
init_worker_by_lua_file /etc/openresty/lua/init_worker.lua;

server {
    listen       80;
    server_name  ${SERVER_NAME};
    # Redirect to HTTPS with smart port handling (omits :443 for standard port)
    set_by_lua_block $https_redirect {
        local config = ngx.shared.config
        local port = config:get("https_port")
        if port == "443" then
            return "https://" .. ngx.var.host .. ngx.var.request_uri
        else
            return "https://" .. ngx.var.host .. ":" .. port .. ngx.var.request_uri
        end
    }
    location /.well-known/pki-validation/ {
        root /var/www/html;
        allow all;
        # Uncomment next line for HTTP server validation and get an SSL certificate issued
        #autoindex on;
    }

    # ACME HTTP-01 challenge (certbot webroot)
    location ^~ /.well-known/acme-challenge/ {
        alias /var/www/certbot/.well-known/acme-challenge/;
        default_type "text/plain";
        allow all;
    }

    location / {
        return 301 $https_redirect;
    }
}

server {
    listen 443 ssl;
    http2 on;
    server_name ${SERVER_NAME};

    # CORS allowlist for browser clients (comma-separated origins).
    set_by_lua_block $cors_allow_origin {
        local origin = ngx.var.http_origin
        if not origin or origin == "" then
            return ""
        end

        local function trim(value)
            return (value:gsub("^%s*(.-)%s*$", "%1"))
        end
        origin = trim(origin)
        if origin:sub(-1) == "/" then
            origin = origin:sub(1, -2)
        end

        -- Build allowed origins list: CORS_ALLOWED_ORIGINS or fallback to MARKETPLACE_URL + same-origin
        local allowed = os.getenv("CORS_ALLOWED_ORIGINS") or ""
        local config = ngx.shared.config
        local server_name = config:get("server_name") or "localhost"
        
        if allowed == "" then
            -- Fallback: allow MARKETPLACE_URL and same-origin
            local marketplace_url = os.getenv("MARKETPLACE_URL") or "https://marketplace-decentralabs.vercel.app"
            local https_port = config:get("https_port") or "443"
            local port_segment = (https_port == "443") and "" or (":" .. https_port)
            local same_origin = "https://" .. server_name .. port_segment
            allowed = marketplace_url .. "," .. same_origin
        end
        
        -- ALWAYS ensure the gateway's own origin is allowed (regardless of CORS_ALLOWED_ORIGINS setting)
        -- This is critical for same-site cross-origin requests (e.g., ceremony page â†’ API)
        local host_origin = "https://" .. (ngx.var.host or server_name)
        if not allowed:find(host_origin, 1, true) then
            if allowed == "" then
                allowed = host_origin
            else
                allowed = allowed .. "," .. host_origin
            end
        end

        for entry in allowed:gmatch("([^,]+)") do
            local candidate = trim(entry)
            if candidate:sub(-1) == "/" then
                candidate = candidate:sub(1, -2)
            end
            if candidate == "*" then
                return origin
            end
            if candidate ~= "" and candidate == origin then
                return origin
            end
        end

        return "DENY"
    }

    ssl_certificate /etc/ssl/private/fullchain.pem;
    ssl_certificate_key /etc/ssl/private/privkey.pem;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384';
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header Referrer-Policy no-referrer-when-downgrade;
    add_header X-XSS-Protection "1; mode=block";

    access_log /dev/stdout;
    set_by_lua_block $ops_upstream {
        local base = os.getenv("OPS_API_URL") or "http://ops-worker:8081"
        if base:sub(-1) == "/" then
            base = base:sub(1, -2)
        end
        return base
    }
    set_by_lua_block $ops_health_upstream {
        local base = os.getenv("OPS_API_URL") or "http://ops-worker:8081"
        if base:sub(-1) == "/" then
            base = base:sub(1, -2)
        end
        return base .. "/health"
    }

    location / {
        root /var/www/html;
        index index.html;
        try_files $uri $uri/ =404;
    }

    # Ensure /lab-manager sets cookie even without trailing slash
    location = /lab-manager {
        set_by_lua_block $ops_secret { return os.getenv("OPS_SECRET") or "" }
        if ($ops_secret != "") {
            add_header Set-Cookie "ops_token=$ops_secret; Path=/ops/; HttpOnly; Secure; SameSite=Lax";
        }
        content_by_lua_block {
            local token = ngx.var.arg_token
            if token and token ~= "" then
                local expected = os.getenv("LAB_MANAGER_TOKEN") or ""
                if expected ~= "" and token == expected then
                    local cookie_name = os.getenv("LAB_MANAGER_TOKEN_COOKIE") or "lab_manager_token"
                    ngx.header["Set-Cookie"] = cookie_name .. "=" .. token .. "; Path=/; HttpOnly; Secure; SameSite=Lax"
                    return ngx.redirect("/lab-manager/", 302)
                end

                ngx.status = ngx.HTTP_UNAUTHORIZED
                ngx.header["Content-Type"] = "text/plain"
                if expected == "" then
                    ngx.say("Unauthorized: LAB_MANAGER_TOKEN not set; access allowed only from 127.0.0.1 or 172.16.0.0/12.")
                else
                    ngx.say("Unauthorized: invalid lab manager token. Use /lab-manager?token=LAB_MANAGER_TOKEN.")
                end
                return ngx.exit(ngx.HTTP_UNAUTHORIZED)
            end

            return ngx.redirect("/lab-manager/", 301)
        }
    }

    # Set ops_token cookie for Lab Manager (admin UI). Uses OPS_SECRET; scoped to /ops/.
    location /lab-manager/ {
        access_by_lua_file /etc/openresty/lua/lab_manager_access.lua;
        set_by_lua_block $ops_secret { return os.getenv("OPS_SECRET") or "" }
        if ($ops_secret != "") {
            add_header Set-Cookie "ops_token=$ops_secret; Path=/ops/; HttpOnly; Secure; SameSite=Lax";
        }
        root /var/www/html;
        index index.html;
        try_files $uri $uri/ /lab-manager/index.html;
    }

    # Blockchain Services - Authentication microservice
    location /auth {
        set $cors_preflight_origin $cors_allow_origin;
        if ($cors_preflight_origin = "DENY") {
            set $cors_preflight_origin "";
        }
        if ($cors_preflight_origin = "") {
            set $cors_preflight_origin $http_origin;
        }

        # Handle preflight requests
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' $cors_preflight_origin always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE' always;
            add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, X-Requested-With' always;
            add_header 'Access-Control-Max-Age' 1728000 always;
            add_header 'Vary' 'Origin' always;
            return 204;
        }

        # Enable CORS for authentication endpoints
        if ($cors_allow_origin = "DENY") {
            return 403;
        }
        if ($cors_allow_origin != "") {
            add_header 'Access-Control-Allow-Origin' $cors_allow_origin always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE' always;
            add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, X-Requested-With' always;
            add_header 'Access-Control-Max-Age' 1728000 always;
            add_header 'Vary' 'Origin' always;
        }

        # Proxy configuration for blockchain-services
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        
        # Timeout configuration for blockchain operations
        proxy_read_timeout 30s;
        proxy_connect_timeout 10s;
        proxy_send_timeout 10s;
        
        # Buffer configuration
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        
        # JSON payload size limit
        client_max_body_size 1M;
        
        # Resolver for service discovery
        resolver 127.0.0.11 valid=5s;
        
        # Proxy to blockchain-services container (using variable for dynamic resolution)
        set $backend_auth http://blockchain-services:8080;
        proxy_pass $backend_auth;
    }

    location = /.well-known/openid-configuration {
        if ($cors_allow_origin = "DENY") {
            return 403;
        }
        if ($cors_allow_origin != "") {
            add_header 'Access-Control-Allow-Origin' $cors_allow_origin always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;
            add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, X-Requested-With' always;
            add_header 'Access-Control-Max-Age' 1728000 always;
            add_header 'Vary' 'Origin' always;
        }

        if ($request_method = 'OPTIONS') {
            return 204;
        }

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        resolver 127.0.0.11 valid=5s;
        proxy_pass http://blockchain-services:8080/.well-known/openid-configuration;
    }

    # Wallet & Treasury Admin Dashboard (static files)
    # Ensure both /wallet-dashboard and /wallet-dashboard/ work
    location = /wallet-dashboard {
        content_by_lua_block {
            local token = ngx.var.arg_token
            if token and token ~= "" then
                local expected = os.getenv("SECURITY_ACCESS_TOKEN") or ""
                if expected ~= "" and token == expected then
                    local cookie_name = os.getenv("SECURITY_ACCESS_TOKEN_COOKIE") or "access_token"
                    ngx.header["Set-Cookie"] = cookie_name .. "=" .. token .. "; Path=/; HttpOnly; Secure; SameSite=Lax"
                    return ngx.redirect("/wallet-dashboard/", 302)
                end

                ngx.status = ngx.HTTP_UNAUTHORIZED
                ngx.header["Content-Type"] = "text/plain"
                if expected == "" then
                    ngx.say("Forbidden: Remote access is disabled. To enable external access, set SECURITY_ACCESS_TOKEN in your .env file and restart the service.")
                else
                    ngx.say("Unauthorized: Invalid access token. Use /wallet-dashboard?token=YOUR_ACCESS_TOKEN.")
                end
                return ngx.exit(ngx.HTTP_UNAUTHORIZED)
            end

            return ngx.redirect("/wallet-dashboard/", 301)
        }
    }
    location /wallet-dashboard/ {
        access_by_lua_file /etc/openresty/lua/internal_access.lua;
        # Proxy configuration for blockchain-services static dashboard
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Resolver for service discovery
        resolver 127.0.0.11 valid=5s;
        
        # Proxy to blockchain-services container (Spring Boot serves static from /) (using variable for dynamic resolution)
        set $backend_wallet_dash http://blockchain-services:8080;
        proxy_pass $backend_wallet_dash;
    }

    # Institution configuration UI + provisioning token endpoints
    location = /institution-config {
        return 307 /institution-config/;
    }

    location /institution-config/ {
        access_by_lua_file /etc/openresty/lua/internal_access.lua;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Treat these accesses as internal so blockchain-services accepts them
        proxy_set_header X-Real-IP 127.0.0.1;
        proxy_set_header X-Forwarded-For 127.0.0.1;

        # Resolver for service discovery
        resolver 127.0.0.11 valid=5s;

        # Proxy to blockchain-services container
        set $backend_institution_config http://blockchain-services:8080;
        proxy_pass $backend_institution_config;
    }

    # Treasury API endpoints
    # Admin endpoints require the access token guard.
    location /treasury/admin/ {
        access_by_lua_file /etc/openresty/lua/admin_access.lua;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        resolver 127.0.0.11 valid=5s;
        set $backend_treasury_admin http://blockchain-services:8080;
        proxy_pass $backend_treasury_admin;
    }

    location /treasury/ {
        access_by_lua_file /etc/openresty/lua/internal_access.lua;
        # Enable CORS for API endpoints
        if ($cors_allow_origin = "DENY") {
            return 403;
        }
        if ($cors_allow_origin != "") {
            add_header 'Access-Control-Allow-Origin' $cors_allow_origin always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE' always;
            add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, X-Requested-With' always;
            add_header 'Access-Control-Max-Age' 1728000 always;
            add_header 'Vary' 'Origin' always;
        }

        # Handle preflight requests
        if ($request_method = 'OPTIONS') {
            return 204;
        }

        # Proxy configuration
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        # Timeout configuration for blockchain operations
        proxy_read_timeout 60s;
        proxy_connect_timeout 10s;
        proxy_send_timeout 10s;
        
        # Resolver for service discovery
        resolver 127.0.0.11 valid=5s;
        
        # Proxy to blockchain-services treasury API (using variable for dynamic resolution)
        set $backend_treasury http://blockchain-services:8080;
        proxy_pass $backend_treasury;
    }

    # Wallet API endpoints
    location /wallet/ {
        access_by_lua_file /etc/openresty/lua/internal_access.lua;
        # Enable CORS for API endpoints
        if ($cors_allow_origin = "DENY") {
            return 403;
        }
        if ($cors_allow_origin != "") {
            add_header 'Access-Control-Allow-Origin' $cors_allow_origin always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE' always;
            add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, X-Requested-With' always;
            add_header 'Access-Control-Max-Age' 1728000 always;
            add_header 'Vary' 'Origin' always;
        }

        # Handle preflight requests
        if ($request_method = 'OPTIONS') {
            return 204;
        }

        # Proxy configuration
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        # Timeout configuration for blockchain operations
        proxy_read_timeout 60s;
        proxy_connect_timeout 10s;
        proxy_send_timeout 10s;
        
        # Resolver for service discovery
        resolver 127.0.0.11 valid=5s;
        
        # Proxy to blockchain-services wallet API (using variable for dynamic resolution)
        set $backend_wallet http://blockchain-services:8080;
        proxy_pass $backend_wallet;
    }

    # WebAuthn Onboarding endpoints (user credential registration)
    # These endpoints implement the dedicated onboarding endpoint from the Federated SSO spec
    # where the browser talks directly to the WIB for WebAuthn credential registration.
    location /onboarding/webauthn/ {
        # Enable CORS for SP/marketplace origins
        if ($cors_allow_origin = "DENY") {
            return 403;
        }

        # Handle preflight requests - must include CORS headers in response
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' $cors_allow_origin always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, X-Requested-With' always;
            add_header 'Access-Control-Max-Age' 1728000 always;
            add_header 'Vary' 'Origin' always;
            return 204;
        }

        # CORS headers for actual requests
        add_header 'Access-Control-Allow-Origin' $cors_allow_origin always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        add_header 'Vary' 'Origin' always;

        # Proxy configuration
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        # Timeout configuration
        proxy_read_timeout 30s;
        proxy_connect_timeout 10s;
        proxy_send_timeout 10s;

        # JSON payload size limit
        client_max_body_size 100k;

        # Resolver for service discovery
        resolver 127.0.0.11 valid=5s;

        # Proxy to blockchain-services container
        set $backend_onboarding http://blockchain-services:8080;
        proxy_pass $backend_onboarding;
    }

    # Intent endpoints (institutional intents ingress)
    location = /intents {
        return 307 /intents/;
    }

    location /intents/ {
        if ($cors_allow_origin = "DENY") {
            return 403;
        }
        if ($cors_allow_origin != "") {
            add_header 'Access-Control-Allow-Origin' $cors_allow_origin always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE' always;
            add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, X-Requested-With, x-api-key' always;
            add_header 'Access-Control-Max-Age' 1728000 always;
            add_header 'Vary' 'Origin' always;
        }

        # Rate limiting
        limit_req zone=intents burst=10 nodelay;

        if ($request_method = 'OPTIONS') {
            return 204;
        }

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        proxy_read_timeout 30s;
        proxy_connect_timeout 10s;
        proxy_send_timeout 10s;
        client_max_body_size 1M;

        resolver 127.0.0.11 valid=5s;
        set $backend_intents http://blockchain-services:8080;
        proxy_pass $backend_intents;
    }

    # Lab Station ops worker (WoL, WinRM proxy, heartbeat poller)
    location /ops/ {
        allow 127.0.0.1;
        allow 172.16.0.0/12;
        deny all;
        # ACL: requires OPS_SECRET env and matching X-Ops-Token header OR ops_token cookie
        set_by_lua_block $ops_expected { return os.getenv("OPS_SECRET") or "" }
        set $ops_token $http_x_ops_token;
        if ($ops_token = "") {
            set $ops_token $cookie_ops_token;
        }

        # CORS reducido al propio host; sin credenciales
        set $ops_origin $scheme://$server_name;
        add_header 'Access-Control-Allow-Origin' $ops_origin always;
        add_header 'Access-Control-Allow-Credentials' 'false' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Content-Type, X-Ops-Token' always;
        add_header 'Access-Control-Max-Age' 1728000 always;

        if ($request_method = 'OPTIONS') {
            return 204;
        }

        if ($ops_expected = "") {
            return 503;
        }
        if ($ops_token != $ops_expected) {
            return 401;
        }

        rewrite ^/ops/(.*)$ /$1 break;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 30s;
        proxy_connect_timeout 10s;
        proxy_send_timeout 10s;
        resolver 127.0.0.11 valid=5s ipv6=off;
        proxy_next_upstream off;
        access_by_lua_block {
            local resolver = require "resty.dns.resolver"
            local r, err = resolver:new{ nameservers = {"127.0.0.11"} }
            if not r then
                return ngx.exit(503)
            end
            local ans, err = r:query("ops-worker")
            if not ans or ans.errcode or not ans[1] or not ans[1].address then
                return ngx.exit(503)
            end
        }
        proxy_pass $ops_upstream$uri$is_args$args;
    }

    # Health check endpoint
    location /health {
        # Proxy configuration
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        
        # Resolver for service discovery
        resolver 127.0.0.11 valid=5s;
        
        # Proxy to blockchain-services health check
        proxy_pass http://blockchain-services:8080/health;
    }

    # Aggregated gateway health (guacamole + blockchain-services)
    location /gateway/health {
        if ($cors_allow_origin = "DENY") {
            return 403;
        }
        if ($cors_allow_origin != "") {
            add_header 'Access-Control-Allow-Origin' $cors_allow_origin always;
            add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS' always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;
            add_header 'Access-Control-Allow-Headers' 'Content-Type' always;
            add_header 'Vary' 'Origin' always;
        }
        if ($request_method = 'OPTIONS') {
            return 204;
        }
        content_by_lua_file /etc/openresty/lua/gateway_health.lua;
    }

    # Internal helpers for aggregated health
    location = /__health_blockchain {
        internal;
        proxy_set_header Host blockchain-services;
        resolver 127.0.0.11 valid=5s;
        proxy_pass http://blockchain-services:8080/health;
    }

    location = /__health_guacamole {
        internal;
        proxy_set_header Host guacamole;
        resolver 127.0.0.11 valid=5s;
        proxy_pass http://guacamole:8080/guacamole/;
    }

    location = /__health_guac_api {
        internal;
        proxy_set_header Host guacamole;
        resolver 127.0.0.11 valid=5s;
        proxy_pass http://guacamole:8080/guacamole/api/tokens;
    }

    location = /__health_ops {
        internal;
        proxy_set_header Host ops-worker;
        resolver 127.0.0.11 valid=5s;
        proxy_pass $ops_health_upstream;
    }

    location /guacamole/ {
        # Enable CORS
        #add_header 'Access-Control-Allow-Origin' $http_origin always;
        #add_header 'Access-Control-Allow-Credentials' 'true' always;
        #add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS' always;
        #add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type' always;
        #add_header 'Access-Control-Max-Age' 1728000 always;

        #if ($request_method = 'OPTIONS') {
        #    return 204;
        #}

        # Lua code to check the cookies and set the authorization header when it applies
        access_by_lua_file /etc/openresty/lua/access.lua;

        # Lua code to look for a token in the URL, validate it and to return a cookie when needed
        header_filter_by_lua_file /etc/openresty/lua/header_filter.lua;

        # Lua code to capture Guacamole's session token and store so the worker can later revoke it
        body_filter_by_lua_file /etc/openresty/lua/body_filter.lua;

        # Lua code to detect WebSocket tunnel closures and mark sessions for revocation
        log_by_lua_file /etc/openresty/lua/log.lua;

        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Accept-Encoding "";
        
        # Disable automatic Location header rewriting - handled in Lua
        proxy_redirect off;
        
        proxy_buffering off;
        proxy_read_timeout 600s;
        proxy_connect_timeout 600s;
        proxy_send_timeout 600s;
        proxy_set_header Connection $http_connection;
        proxy_http_version 1.1;
        client_max_body_size 5M;
        access_log off;
        resolver 127.0.0.11;

        proxy_pass http://guacamole:8080/guacamole/;
    }   
}
